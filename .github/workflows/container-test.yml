name: "Container build and test"

on:
  workflow_call:

permissions:
  contents: read

jobs:
  podman-build:
    name: Utility Container Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download AMD64 image
        uses: actions/download-artifact@v5
        with:
          name: image-amd64-${{ github.run_id }}
          path: /tmp

      - name: Load tarballs into local containers-storage
        run: |
          buildah pull docker-archive:/tmp/image-amd64.tar
          make manifest
          buildah manifest add --arch=amd64 "${{ env.CONTAINER }}" "${{ env.CONTAINER }}-amd64"
        env:
          CONTAINER: utility-container:latest

      - name: Run Container tests
        run: make test-amd64

      - name: Clone MCG and test a target via container
        run: |
          git clone --depth 1 https://github.com/hybrid-cloud-patterns/multicloud-gitops
          cd multicloud-gitops
          export PATTERN_UTILITY_CONTAINER=localhost/utility-container:latest-amd64
          ./pattern.sh make validate-schema
